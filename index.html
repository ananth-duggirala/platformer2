<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        canvas {
            background: #eee;
            display: block;
            margin: 0 auto;
        }
    </style>
</head>

<body>

    <canvas id="myCanvas" width="800" height="900"></canvas>

    <script>
        // JavaScript code goes here

        class RectangularPlatform {
            width;
            height;
            constructor(x1, y1, x2, y2) {
                this.x1 = x1;
                this.y1 = y1;
                this.x2 = x2;
                this.y2 = y2;
                this.height = y2 - y1;
                this.width = x2 - x1;
                // drawPlatform(ctx);
            }

            drawPlatform(ctx) {
                ctx.beginPath();
                ctx.rect(this.x1, this.y1, this.width, this.height);
                ctx.fillStyle = "#0095DD";
                ctx.fill();
                ctx.closePath();
            }
        }

        class User {
            constructor(x, y, radius, x_vel, y_vel) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.x_vel = x_vel;
                this.y_vel = y_vel;
            }

            drawUser(ctx) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); //change this back
                ctx.fillStyle = "#0095DD";
                ctx.fill();
                ctx.closePath();
            }
        }

        class Agent {
            constructor(x, y, radius, x_vel, y_vel) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.x_vel = x_vel;
                this.y_vel = y_vel;
            }

            drawUser(ctx) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = "#0095DD";
                ctx.fill();
                ctx.closePath();
            }
        }

        function loadMap(canvas) {
            var platforms = [];
            for (var i = 0; i < 4; i++) {
                x1 = i * canvas.width / 4;
                y1 = (4 - i) * canvas.height / 4;
                x2 = x1 + 60;
                y2 = y1 - 10;
                platforms.push(new RectangularPlatform(x1, y1, x2, y2));
            }
            return platforms;
        }

        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");

        var x = canvas.width / 16;

        var ballRadius = 15;
        var y = canvas.height - ballRadius;
        var dx = 0;
        var dy = 0;
        var platformWidth = 60;
        var platformHeight = 10;

        var maxBallSpeed = 4;
        X_ACCL = 0.2;

        var G = 0.1 // gravitational acceleration


        var user = new User(x, y, ballRadius, dx, dy);
        var platforms = loadMap(canvas);

        var rightPressed = false;
        var leftPressed = false;
        var upPressed = false;
        var time = 0;

        class CollisionDetection {
            constructor(width, height, user, platforms, g) {
                this.width = width;
                this.height = height;
                this.user = user;
                this.platforms = platforms;
                this.g = g;
            }

            detectCollisionAndUpdate() {
                // 1. Detect collision with side and top walls 
                if (this.user.x + this.user.x_vel > this.width - this.user.radius ||
                    this.user.x + this.user.x_vel < this.user.radius) {
                    this.user.x_vel = -this.user.x_vel;
                }
                if (this.user.y + this.user.y_vel < this.user.radius) {
                    this.user.y_vel = -this.user.y_vel;
                }

                // 2. Detect collision with platforms
                var isPlatformUnderneath = false;

                for (var i = 0; i < this.platforms.length; i++) {
                    if (this.user.x > this.platforms[i].x1 && this.user.x < this.platforms[i].x1 + this.platforms[i].width
                        && this.user.y < this.platforms[i].y1 && this.user.y + this.user.radius + this.user.y_vel >= this.platforms[i].y1) {
                        this.user.y_vel = Math.min(this.user.y_vel, 0);
                        this.user.y = this.platforms[i].y1 - this.user.radius;
                        isPlatformUnderneath = true;
                        console.log("platform under");
                    }
                }

                // 3. Floor detection and update velocities
                this.user.x += this.user.x_vel;
                if (this.user.y >= this.height - this.user.radius) {
                    // console.log()
                    //        	alert("GAME OVER"); 
                    //        	document.location.reload();
                    //        	clearInterval(interval);
                    this.user.y_vel = Math.min(this.user.y_vel, 0);
                    if (this.user.y_vel == 0) {
                        this.user.y = this.height - this.user.radius;
                    } else {
                        this.user.y += this.user.y_vel;
                    }
                }
                else if (!isPlatformUnderneath) {
                    this.user.y_vel += this.g
                    this.user.y += this.user.y_vel;
                }


            }
        }

        console.log("hello" + user.radius);

        var collisionEngine = new CollisionDetection(canvas.width, canvas.height, user, platforms, G);

        function draw() {
            time += 1;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            user.drawUser(ctx);

            for (var i = 0; i < platforms.length; i++) {
                platforms[i].drawPlatform(ctx);
            }

            // if (time % 10 == 0)
            console.log("t = " + time + " v_y = " + dy + " y = " + y);
            collisionEngine.detectCollisionAndUpdate();


            if (rightPressed) {
                if (user.x_vel <= maxBallSpeed) {
                    user.x_vel += X_ACCL;
                }
            }
            else if (leftPressed) {
                if (user.x_vel >= -maxBallSpeed) {
                    user.x_vel -= X_ACCL;
                }
            }
            if (upPressed) {
                if (user.y_vel == 0) {
                    user.y_vel = -7.5;
                }
            }
        }


        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);


        function keyDownHandler(e) {
            if (e.key == "Right" || e.key == "ArrowRight") {
                rightPressed = true;
            }
            else if (e.key == "Left" || e.key == "ArrowLeft") {
                leftPressed = true;
            }
            else if (e.key == "Up" || e.key == "ArrowUp") {
                upPressed = true;
            }
        }

        function keyUpHandler(e) {
            if (e.key == "Right" || e.key == "ArrowRight") {
                rightPressed = false;
            }
            else if (e.key == "Left" || e.key == "ArrowLeft") {
                leftPressed = false;
            }
            else if (e.key == "Up" || e.key == "ArrowUp") {
                upPressed = false;
            }
        }

        var interval = setInterval(draw, 10);

    </script>

</body>

</html>